<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .playGround {
            position: absolute;
            margin-left: 210px;
            margin-top: 52.5px;
            width: 280px;
            height: 429.5px;
            /* border: 1px solid yellow; */
            z-index: 3;
        }
        .bubblePathRound {
            position: absolute;
            width: 240px;
            height:389.5px;
            margin-left: 20px;
            margin-top: 20px;
            /* border: 1px rgb(14, 231, 61) solid; */
            z-index: 5;
        }
        .wrapper{
            margin-top: 100px;
			width: 700px;
			height: 504px;
			/* border: 1px solid red; */
			position: relative;
			margin: 0 auto;
			overflow: hidden;
		}
        .arrow {
            /* margin: auto; */
            /* margin-top: 387px; */
            /* margin-left: 332.5px; */

            margin-top: 333px;
            margin-left: 122px;
            position: absolute;
            z-index: 3;
            /* transform: rotate(90deg); */
            
        }
        .bubble {
            margin-top: 585px;
            margin-left: 369px;
            position: absolute;
            z-index: 1;
        }
        .line {
            width: 1px;
            height: 1748px;
            margin-top: -443.5px;
            margin-left: 349.5px;
            border: 1px solid black;
            position: relative;
        }
        .attr {
            position: absolute; top:0; left:0;
            width: 100%;
            height: 100%;
        }
        #blue {
            /* width: 40px;
            height: 40px; */
            /* margin-top: 338px;
            margin-left: 100.5px; */
            z-index: 2;
            /* visibility: hidden; */
        }
        #red {
            z-index: 2;
        }

        #yellow {
            z-index: 2;
        }
        #green {
            z-index: 2;
        }

        .stopBubble {
            width: 40px;
            height: 40px;
            margin-top: 338px;
            margin-left: 100.5px;
            position: absolute;
            z-index: 3;
        }

        .loadedBubble {
            width: 40px;
            height: 40px;
            margin-top: 338px;
            margin-left: 100.5px;
            z-index: 2;
            position: absolute;
            /* transition: all, 0.5s; */
        }
        .waitBubble {
            width: 40px;
            height: 40px;
            margin-top: 350px;
            margin-left: 200px;
            z-index: 2;
            position: absolute;
            /* top = 12
            left 99.5 */
        }
        #test {
            width: 40px;
            height: 40px;
            margin-left: 200px;
            margin-top: -20px; 
        }
        #test2 {
            width: 40px;
            height: 40px;
            margin-left: 101px;
            margin-top: -20px; 
        }
        .movingBubble {
            width: 40px;
            height: 40px;
            margin-top: 338px;
            margin-left: 100.5px;
            z-index: 2;
            position: absolute;
        }
        .startBubble {

        }

    </style>
</head>

<body>
    <div class="wrapper">
        <div class="playGround">
            <img src="img/arrow2.png" alt="" class="arrow">
            <div class="bubblePathRound"></div>
        </div>
        <img src="img/ATTRACT1.png" alt="" class="attr">
        <img src="img/blueLine4.png" alt="" class="line">
        <!-- <div class="lunchBubble"></div> -->
        
    </div>
    <!-- <canvas id="canvas" class="tutorial" ></canvas> -->
    <input type="text" id="delayInput" class="asd">

<script src="jquery-3.2.0.js"></script>
<script>

$(document).ready(()=> {
    init();
})


function init() {
    $('#delayInput').focus();
}

var line = $('.line');      // 직선 개체
var arrow = $('.arrow');    // 화살표 개체
var bubble = $('.bubble');  // 버블 개체
var i = 19;
var blue = $('#blue');

var waitBubble;
var cmplBubble;


var nx = 0;

// 버블 각도
var bubbleDeg = 0;

var bSpeed = 5;


// 초기 버블
var randomBubble = Math.floor((Math.random()*4))
var bubbleColor;






$('.bubblePathRound').append('<img src="img/red.png" class="bubble stopBubble startBubble" id="test">')
$('.bubblePathRound').append('<img src="img/blue.png" class="bubble stopBubble startBubble" id="test2">')
switch(randomBubble) {
    case 0:
        bubbleColor = 'blue';
        break;
    case 1:
        bubbleColor = 'red';
        break;
    case 2:
        bubbleColor = 'green';
        break;
    case 3:
        bubbleColor = 'yellow';
        break;
}

$('.bubblePathRound').append('<img src="img/'+bubbleColor+'.png" class="bubble loadedBubble" id='+bubbleColor+'>')

for(var k = 0; k<20; k++) {
    var randomWaitb = Math.floor((Math.random()*4))
    switch(randomWaitb) {
    case 0:
        bubbleColor = 'blue';
        break;
    case 1:
        bubbleColor = 'red';
        break;
    case 2:
        bubbleColor = 'green';
        break;
    case 3:
        bubbleColor = 'yellow';
        break;
    }
    $('.bubblePathRound').append('<img src="img/'+bubbleColor+'.png" class="bubble waitBubble" id='+k+'>')
}



// 발사후에 버블 클래스 변경 & 다음 입력 딜레이
function reload() {

    var bubble = $('.bubble');
    var stopBubble = $('.stopBubble');
    var loadedBubble = $('.loadedBubble');

    // 빠르게 스페이스바를 연타했을때 loadedBubble이 2개 이상 생기는 issue 방지
    if(!bubble.hasClass('loadedBubble')) {
            this.removeClass('loadedBubble')
    }
   

    $('#'+i).animate({top:-12, left:-99.5}, function() {
    // $('#'+i).addClass("loadedBubble").removeClass("waitBubble");
    // $('#'+i-1).removeClass('loadedBubble')

        
        $('#'+i).removeClass().addClass('loadedBubble').addClass('bubble').css('top', '0').css('left', '0')
        i--;
        // console.log(i)
        input.focus();
    })
    

    // 19번 부터 loadedBubble이 발사되면 차례대로 loadedBubble로 animate
    loadedBubble.removeClass('loadedBubble');
    
}
var lastBubble;

function nearBBChk() {
    var stopBubble = $('.stopBubble');
    
    // for(var i = 0; i<stopBubble.length; i++) {
    //     console.log(i+'번째 offsetTop 은 '+stopBubble[i].offsetTop)
    //     for(var j = 0; j<stopBubble.length-1; j++) {
        
    //     }
    // }

    
    // console.log(lastBubble.offsetTop)
    
    
}

function bubbleClassChange() {
    var movingBubble = $('.movingBubble');
    movingBubble.removeClass().addClass('stopBubble')
    nearBBChk();
}


function test() {
    console.log('test')
}

// 입력된 키를 담아둘 오브젝트
var keypress={};

var input = $('#delayInput');

function bubbleExplosion() {
    var stopBubble = $('.stopBubble');
    var allBubble = [];

    for(var i =0; i<stopBubble.length; i++) {
        allBubble.push(stopBubble[i].outerHTML)
    }

}

input.keydown(function(e) {
    // 모든 버블
    var bubbleArray = {};
    // console.log(e.keyCode)
        var loadedBubble = $('.loadedBubble')
        var movingBubble = $('.movingBubble')
        // var a = document.getElementById('p').childNodes;
        // var startTime = new Date('1/1/1990');
        // var startMsec = startTime.getMilliseconds();
        // startTime.setTime(5000000);
        // var elapsed = (startTime.getTime() - startMsec) / 1000; 
        // console.log(elapsed)
        // var waitBubble = $('.waitBubble')
        
        // bubbleArray.x = waitBubble[i].x
        // console.log(bubbleArray.x)
        // console.log(bubbleArray)

        var rad = 2*Math.PI*(bubbleDeg/360);    // Radian
        var y = 358*Math.tan(rad);
        var y2 = 121/Math.tan(rad);
        // console.log(bubbleDeg)
        var tan = Math.tan(rad);
        var y3 = 242/tan;
        
        // space == 32
        if(e.keyCode==229) {
            // console.log(keyFlag)
            input.blur();
            
        }

        if(e.keyCode==32) {
            // clearInterval(check);
            
            // ???
            loadedBubble.addClass('movingBubble').addClass('bubble')
            
            // 제어권을 잃는다
            input.blur();
            
            
            // keyFlag=true;
            // console.log(keyFlag)
            var bounce; // 튕기는 횟수
            // 각도에 따른 팅기는 횟수
            if(bubbleDeg>=0 && bubbleDeg<18.63 || bubbleDeg<0 && bubbleDeg>=-18.63) bounce = 0;
            else if(bubbleDeg>=18.63 && bubbleDeg<45.32 || bubbleDeg<-18.63 && bubbleDeg>=-45.32) bounce = 1;
            else if(bubbleDeg>=45.32 && bubbleDeg<59.32 || bubbleDeg<-45.32 && bubbleDeg>=-59.32) bounce = 2;
            else if(bubbleDeg>=59.32 && bubbleDeg<67.03 || bubbleDeg<-59.32 && bubbleDeg>=-67.03) bounce = 3;
            else if(bubbleDeg>=67.03 && bubbleDeg<71.79 || bubbleDeg<-67.03 && bubbleDeg>=-71.79) bounce = 4;

            // 양수 음수 상태, 판별
            var status = false; 
            if(bubbleDeg>=0) status=true;  
            else status = false;
            
            
            // var b = $('.bubblePathRound').children().last();    
            // var c = $('.bubblePathRound').children().first(); // loadedBubble
            
            
            if(status) {    // 각도가 양수일 때
                switch(bounce) {

                    case 0: // 0번 팅길때
                        loadedBubble.animate({top:-359, left:tan*359}, bubbleClassChange)
                        collision();    // 충돌될때 멈추기
                        
                        // launchingDelay();
                        break;
                        
                    case 1: // 1번 팅길때
                        loadedBubble.animate({top:-y2, left:121}, function() {
                            loadedBubble.animate({top:-359, left:121-((359-y2)*tan)}, bubbleClassChange)
                        })
                        // loadedBubble.animate({top:-y2, left:121}).animate({top:-359, left:121-((359-y2)*tan)}, bubbleClassChange)
                        console.log(y2)
                        collision();
                        // launchingDelay();
                        break;

                    case 2: // 2번 팅길 때
                        // loadedBubble.animate({top:-y2, left:121}).animate({top:-3*y2, left:-121}).animate({top:-359, left:-(121-((359-(3*y2))*tan))}, bubbleClassChange)
                        loadedBubble.animate({top:-y2, left:121}, function() {
                            loadedBubble.animate({top:-3*y2, left:-121}, function() {
                                loadedBubble.animate({top:-359, left:-(121-((359-(3*y2))*tan))}, bubbleClassChange)
                            })
                        })
                    
                        collision();
                        break;

                    case 3: // 3번 팅길 때
                        // loadedBubble.animate({top:-y2, left:121}).animate({top:-3*y2, left:-121}).animate({top:-5*y2, left:121}).animate({top:-359, left:121-((359-(5*y2))*tan)}, bubbleClassChange)

                        loadedBubble.animate({top:-y2, left:121}, function() {
                            loadedBubble.animate({top:-3*y2, left:-121}, function() {
                                loadedBubble.animate({top:-5*y2, left:121}, function() {
                                    loadedBubble.animate({top:-359, left:121-((359-(5*y2))*tan)}, bubbleClassChange)
                                })
                            })
                        })

                        collision();
                        break;
                    case 4: // 4번 팅길 때
                        // loadedBubble.animate({top:-y2, left:121}).animate({top:-3*y2, left:-121}).animate({top:-5*y2, left:121}).animate({top:-7*y2, left:-121}).animate({top:-359, left:-(121-((359-(7*y2))*tan))}, bubbleClassChange)

                        loadedBubble.animate({top:-y2, left:121}, function() {
                            loadedBubble.animate({top:-3*y2, left:-121}, function() {
                                loadedBubble.animate({top:-5*y2, left:121}, function() {
                                    loadedBubble.animate({top:-7*y2, left:-121}, function() {
                                        loadedBubble.animate({top:-359, left:-(121-((359-(7*y2))*tan))}, bubbleClassChange)
                                    })
                                })
                            })
                        })
                        collision();
                        break;
                }

            } else {    // 각도가 음수 일때
                switch(bounce) {

                    case 0: // 0번 팅길때
                        loadedBubble.animate({top:-359, left:tan*359}, bubbleClassChange)
                        collision();
                        break;

                    case 1: // 1번 팅길때
                        // loadedBubble.animate({top:y2, left:-121}).animate({top:-359, left:-(121+((359+y2)*tan))}, bubbleClassChange)

                        loadedBubble.animate({top:y2, left:-121}, function() {
                            loadedBubble.animate({top:-359, left:-(121+((359+y2)*tan))}, bubbleClassChange)
                        })
                        collision();
                        break;

                    case 2: // 2번 팅길 때
                        // loadedBubble.animate({top:y2, left:-121}).animate({top:3*y2, left:121}).animate({top:-359, left:(121+((359+(3*y2))*tan))}, bubbleClassChange)

                        loadedBubble.animate({top:y2, left:-121}, function() {
                            loadedBubble.animate({top:3*y2, left:121}, function() {
                                loadedBubble.animate({top:-359, left:(121+((359+(3*y2))*tan))}, bubbleClassChange)
                            })
                        })
                        collision();
                        break;

                    case 3: // 3번 팅길 때
                        // loadedBubble.animate({top:y2, left:-121}).animate({top:3*y2, left:121}).animate({top:5*y2, left:-121}).animate({top:-359, left:-(121+((359+(5*y2))*tan))}, bubbleClassChange)

                        loadedBubble.animate({top:y2, left:-121}, function() {
                            loadedBubble.animate({top:3*y2, left:121}, function() {
                                loadedBubble.animate({top:5*y2, left:-121}, function() {
                                    loadedBubble.animate({top:-359, left:-(121+((359+(5*y2))*tan))}, bubbleClassChange)
                                })
                            })
                        })
                        collision();
                        break;

                    case 4: // 4번 팅길 때
                        // loadedBubble.animate({top:y2, left:-121})
                        // loadedBubble.animate({top:y2, left:-121}).animate({top:3*y2, left:121}).animate({top:5*y2, left:-121}).animate({top:7*y2, left:121}).animate({top:-359, left:-(121+((359+(7*y2))*tan))}, bubbleClassChange)

                        loadedBubble.animate({top:y2, left:-121}, function() {
                            loadedBubble.animate({top:3*y2, left:121}, function() {
                                loadedBubble.animate({top:5*y2, left:-121}, function() {
                                    loadedBubble.animate({top:7*y2, left:121}, function() {
                                        loadedBubble.animate({top:-359, left:-(121+((359+(7*y2))*tan))}, bubbleClassChange)
                                    })
                                })
                            })
                        })
                        collision();
                        break;
                }
            } 
        }
})




function angleTest() {


    window.onkeyup = function(e) {
        // var bubbleY = blue.position().top;
        // var bubbleX = blue.position().left;
        // console.log('bubbleY :'+bubbleY);
        // console.log('bubbleX :'+bubbleX);
        // console.log('CurrentKey : '+e.keyCode);
        // console.log('Degree : '+bubbleDeg);
        // console.log('');

        // 1번 키 입력시 29.74 각도로 이동
        if(e.keyCode==49) {
            console.log('Number 1 press : Go to 20.35 deg')
            console.log('');
            arrow.css('transform', 'rotate(20.35deg)');
            bubble.css('transform', 'rotate(20.35deg)');
            line.css('transform', 'rotate(20.35deg)');
        }

        // 2번 키 입력시 45도 각도로 이동
        if(e.keyCode==50) {
            console.log('Number 2 press : Go to 45 deg')
            console.log('');
            arrow.css('transform', 'rotate(45deg)');
            bubble.css('transform', 'rotate(45deg)');
            line.css('transform', 'rotate(45deg)');
        }

        // 3번 키 입력시 21.39
        if(e.keyCode==51) {


            bubbleExplosion();

            // var z;
            // var p;
            //  var loadedBubble = $('.loadedBubble')
            //  var stopBubble = $('.stopBubble')
            // var x1 = loadedBubble.offset().left+359;
            // var y1 = loadedBubble.offset().top-82;
    
         //    console.log(loadedBubble.offsetTop);
         //    for(var i=0; i<array.length; i++) {
         //     z = array.offset().top-20;
         //    }
         //    console.log('Heelo'+typeof(stopBubble))
             // for(var i = 0; i<stopBubble.length; i++) {
             //     z = stopBubble[i].offsetTop;
             // }
             // console.log(z)
                 
               
                //  console.log(movingBubble.offset().left)
        }

        // 스페이스바 입력시
        // if(e.keyCode==32) {

        //     // 라디안 변환
        //     var rad = 2*Math.PI*(bubbleDeg/360);

        //     // 밑변의 길이
        //     var x = 800*Math.tan(rad)

        //     // var angle = Math.tan(bubbleDeg)
        //     console.log('rad:'+rad)
        //     console.log('x길이는:'+x);

        //     // blue.animate({top:-100,left:-100})
        // }
    }
}

// 화살표 움직임
function moveArrow() {

    // 오른쪽
    if(keypress['39']) {
        this.nx += 1;
        this.bubbleDeg += 1;                 
        arrow.css('transform', 'rotate('+nx+'deg)');
        bubble.css('transform', 'rotate('+bubbleDeg+'deg)');
        line.css('transform', 'rotate('+bubbleDeg+'deg)');
    }

    // 왼쪽
    if(keypress['37']) {
        this.nx -= 1;
        this.bubbleDeg -= 1;
        arrow.css('transform', 'rotate('+nx+'deg)');
        bubble.css('transform', 'rotate('+bubbleDeg+'deg)');
        line.css('transform', 'rotate('+bubbleDeg+'deg)');
    }

    // if(keypress['32']) {
        
    //     this.bSpeed -=5;
    //     bubble.css('transform', 'translateX('+bSpeed+'px)')
    //     bubble.css('transform', 'translateY('+bSpeed+'px)')
    // }
}

// 객체 좌표
function position() {

}


// 충돌 체크
function collision() {
    var input = $('#delayInput');
    var collision = false;
    var bubble = $('.bubble');
    $('.loadedBubble').addClass('movingBubble');
    // $('.loadedBubble').reomveClass('stopBubble')
    var loadedBubble = $('.loadedBubble');
    // var array = stopBubble.toArray();
    var movingBubble = $('.movingBubble');
    
    // var a = document.getElementById('p').childNodes;
    var stopBubble = $('.stopBubble');

    var rad = 2*Math.PI*(bubbleDeg/360);    // Radian
    var y = 358*Math.tan(rad);
    var y2 = 121/Math.tan(rad);
    
    var tan = Math.tan(rad);
    var y3 = 242/tan;
    //     for(var attr in stopBubble) {
    //        console.log(attr)
    //    }
    
    // for(var o = 0; o<stopBubble.length; o++) {
    //     console.log(stopBubble[o].offsetTop)
    // }
    // for(var i = 0; i<1000; i++) {
        
    //     setTimeout(function() {
    //         console.log(movingBubble.offset().top)    
    //     }, 1)
    // }
    var i = 0;
    
    setInterval(function() {
        var loadedBubble = $('.loadedBubble')
        var stopBubble = $('.stopBubble')
        var movingBubble = $('.movingBubble')
        var lchCtrl = movingBubble.hasClass('movingbubble');
        movingBubble.removeClass('.stopBubble')
        // var x1 = loadedBubble.offset().left+359;
        // var y1 = stopBubble[0].offset().top+82;
       
        
        var g;
        var h=0;
        // console.log(movingBubble.offset().top)
        // obj.x = stopBubble[i].offsetLeft;
        
        // g= stopBubble[1].offset().left;
        
        
        // console.log(movingBubble.offset().top-stopBubble[0].offsetTop-81.5)
        // console.log(stopBubble[0].offsetLeft)
        // console.log(movingBubble.offset().left-stopBubble[0].offsetLeft-508)
        var cllx = 0;
        var clly = 0;

        try {

            // g = Math.pow(movingBubble.offset().top-stopBubble[0].offsetTop-81.5, 2) + Math.pow(movingBubble.offset().left-stopBubble[0].offsetLeft-508, 2)
            // h = Math.sqrt(g)
            
            if(movingBubble.hasClass('movingBubble'))
                input.blur();
            else
                input.focus();

            //
            for(var i = 0; i<stopBubble.length; i++) {
                g = Math.pow(movingBubble.position().top-stopBubble[i].offsetTop+339, 2) + Math.pow(movingBubble.position().left-stopBubble[i].offsetLeft+101, 2)
                
                
                h = Math.sqrt(g)
                
                // console.log(movingBubble.position().left+101)
                // console.log(movingBubble.position().top+339)
                // console.log(stopBubble[0].offsetTop-359)
                var x = h - 41
                
                if(h<=40) {
                    collision = true;
                    // console.log(stopBubble[i].offsetLeft)
                    // console.log(x)
                }
                else
                    collision = false;

                if(collision) {
                    
                    // loadedBubble.animate().stop(launchingDelay);
                    // console.log(i)
                    lastBubble = movingBubble[0];
                    
                   




                    clly = Math.pow((lastBubble.offsetTop-stopBubble[i].offsetTop+339), 2);
                    cllx = Math.pow((lastBubble.offsetLeft-stopBubble[i].offsetLeft+101), 2);
                    var y = (Math.sqrt(clly)-340)
                    // var x = (Math.sqrt(cllx)-101)
                    
                    var top1 = y - 40; 
                    // var left1 = x;
                    // console.log(y)
                    // console.log('heelo'+x)
                    // console.log(lastbubble.offsetLeft);
                    // console.log(lastBubble.offsetTop-stopBubble[i].offsetTop)
                    // console.log(lastBubble)
                    
                    
                    movingBubble.stop()
                    .animate({top:lastBubble.offsetTop-x-338.6}, 240, function() {
                        for(var j = 0; j<stopBubble.length; j++) {
                        var array = [];
                        
                        var n;
                        var m;
                        n = Math.pow(movingBubble.position().top-stopBubble[j].offsetTop+339, 2) + Math.pow(movingBubble.position().left-stopBubble[j].offsetLeft+101, 2)
                        m = Math.sqrt(n)
                        if(m<=41) {                              
                            array.push(stopBubble[j])         
                        }
                        console.log(array)
                            // array.push(stopBubble[j]);
                            //     if(array.length>=3) {
                            //         for(var l = 0; l<array.length; l++) {
                            //             array[l].className += " linkedBubble"
                            //         }
                            //     }
                        
                        // 33~37
                        }
                        
                    });  // 붙는 거리 조정
                    
                    // .animate({top:lastBubble.offsetTop-top1-339.5, left:lastBubble.offsetLeft-left1-101})

                    
                    // console.log('hello'+(lastBubble.offsetTop-stopBubble[i].offsetTop))
                    // .animate({top:lastBubble.offsetTop-stopBubble[i].offsetTop-x, left:0});
                    
                    
                    // console.log('offsetTop : '+lastBubble.offsetTop)
                    // for(var i = 0; i<stopBubble.length; i++) {
                    //     console.log(lastBubble.offsetTop-stopBubble[i].offsetTop)
                        
                    //     // console.log(stopBubble[i].offsetTop)
                    // }
                    movingBubble.removeClass('movingBubble').addClass('stopBubble')

                    // nearBBChk();
                    // collision = true;
                } 
            }
            // console.log(collision)
            
        } catch(e) {
            console.log(e.message)
            // return;
        }
    }, 10)

    // 재장전
    reload();
    // clearInterval();
    
}

// 지연 반복
//     (function looper (i) {
// 	setTimeout(function() {
//         var a = Math.abs(stopBubble.offset().top-20);
//         var c = Math.abs(loadedBubble.offset().top-20);
//         var b = Math.abs(stopBubble.offset().left-20);
//         var d = Math.abs(loadedBubble.offset().left-20);
//         var k = ((a-c)*(a-c))+((b-d)*(b-d))
//         var j = Math.sqrt(k)
// 		console.log((a-c))

//         if(j<=39)
//             loadedBubble.animate().stop();

// 		if ( 10 < ++i )
// 			looper (i);
// 	}, 10)
// })(i);

// Stage 1
function stage_1() {

}


angleTest()
// lunch();
// setInterval(lunch, 2000
// setTimeout(lunch, 1000);
setInterval(moveArrow, 10)

$(window).keydown(function(e){ // 어떤 키가 눌렸는지 저장 
    keypress[e.which.toString()] = true;
});
$(window).keyup(function(e){ // 눌렸던 키를 해제
    keypress[e.which.toString()] = false;
    // input.blur();
});    

</script>
</body>
</html>